#include "stdafx.h"
#include "effect.h"
#include "animation.h"


effect::effect()
	: _effectImage(NULL),
	_effectAnimation(NULL),
	_isRunning(false),
	_x(0), _y(0)
{
}


effect::~effect()
{
}

HRESULT effect::init(image* effectImage, int frameW, int frameH, int fps, float elapsedTime)
{
	//이펙트 이미지가 없으면 실패를 띄워라
	if (!effectImage) return E_FAIL;

	_isRunning = false;
	_effectImage = effectImage;
	_elapsedTime = elapsedTime;
	_last = false;
	_move = false;
	_AttacEffect = false;
	_moveCount = 0;
	_angle = 1.57;
	if (!_effectAnimation) _effectAnimation = new animation;

	_effectAnimation->init(_effectImage->getWidth(), _effectImage->getHeight(), frameW, frameH);
	_effectAnimation->setDefPlayFrame(false, false);
	_effectAnimation->setFPS(fps);
	_effectAnimation->stop();

	return S_OK;
}

HRESULT effect::init(image* effectImage, int frameW, int frameH, int fps, float elapsedTime, bool last)
{
	//이펙트 이미지가 없으면 실패를 띄워라
	if (!effectImage) return E_FAIL;

	_isRunning = false;
	_effectImage = effectImage;
	_elapsedTime = elapsedTime;
	_last = last;
	_move = false;
	if (!_effectAnimation) _effectAnimation = new animation;

	_effectAnimation->init(_effectImage->getWidth(), _effectImage->getHeight(), frameW, frameH);
	_effectAnimation->setDefPlayFrame(false, false);
	_effectAnimation->setFPS(fps);
	_effectAnimation->stop();
	_effectAnimation->frameContinue();
	return S_OK;
}

HRESULT effect::init(image* effectImage, int frameW, int frameH, int fps, float elapsedTime, bool last, float x, float y)
{
	//이펙트 이미지가 없으면 실패를 띄워라
	if (!effectImage) return E_FAIL;

	_isRunning = false;
	_effectImage = effectImage;
	_elapsedTime = elapsedTime;
	_last = last;
	_move = false;
	if (!_effectAnimation) _effectAnimation = new animation;

	_effectAnimation->init(_effectImage->getWidth(), _effectImage->getHeight(), frameW, frameH);
	_effectAnimation->setDefPlayFrame(false, false);
	_effectAnimation->setFPS(fps);
	_effectAnimation->frameContinue();
	_effectAnimation->start();

	//if (!_effectImage || !_effectAnimation) return;

	//일단 중앙값으로... 레탑들은 레탑으로 해...
	_x = x - (_effectAnimation->getFrameWidth() / 2);
	_y = y - (_effectAnimation->getFrameHeight() / 2);

	_isRunning = true;

	_effectAnimation->start();

	return S_OK;
}

void effect::release()
{
	_effectImage = NULL;
	SAFE_DELETE(_effectAnimation);
}

void effect::update()
{
	//이펙트 애니메이션 실행 변수가 false면 실행하지마라
	if (!_isRunning) return;

	_effectAnimation->frameUpdate(_elapsedTime);

	//만약 애니메이션 재생신호가 false면 이펙트를 꺼라
	if (!_effectAnimation->isPlay())
	{
		killEffect();	
	}
	move();
}

void effect::render()
{

	if (!_isRunning) return;

	//_effectImage->aniRender(getMemDC(), _x, _y, _effectAnimation);
	_effectImage->aniRender(getMemDC(), _x, _y, _effectAnimation);
}

void effect::render(HDC hdc)
{
	if (!_isRunning) return;
	//_effectImage->aniRender(getMemDC(), _x, _y, _effectAnimation);

	_effectImage->aniRender(hdc, _x, _y, _effectAnimation);
}

void effect::move()
{
	if (!_move) return;

	cout << "move 중이다 " << endl;  // 이펙트 무브 조절해야함 
	_moveCount++;
	if (_moveCount > RND->getFromIntTo(3,10))
	{
		_angle -= RND->getFromFloatTo(0.10f,0.30f);
		_moveCount = 0;
	}
	_x += cosf(_angle) * 2;
	_y += -sinf(_angle) * 2;
}


void effect::startEffect(int x, int y)
{
	if (!_effectImage || !_effectAnimation) return;

	//일단 중앙값으로... 레탑들은 레탑으로 해...
	_x = x - (_effectAnimation->getFrameWidth() / 2);
	_y = y - (_effectAnimation->getFrameHeight() / 2);

	_isRunning = true;

	_effectAnimation->start();
}

void effect::startEffect(float x, float y)
{
	if (!_effectImage || !_effectAnimation) return;

	//일단 중앙값으로... 레탑들은 레탑으로 해...
	_x = x; //- (_effectAnimation->getFrameWidth() / 2);
	_y = y; //- (_effectAnimation->getFrameHeight() / 2);

	_isRunning = true;

	_effectAnimation->start();
}

void effect::startEffect(float x, float y, bool move)
{
	if (!_effectImage || !_effectAnimation) return;

	//일단 중앙값으로... 레탑들은 레탑으로 해...
	_x = x; //- (_effectAnimation->getFrameWidth() / 2);
	_y = y; //- (_effectAnimation->getFrameHeight() / 2);

	_isRunning = true;
	_move = move;
	_angle = 1.57;
	_effectAnimation->start();
}

void effect::killEffect()
{
	_isRunning = false;
}
